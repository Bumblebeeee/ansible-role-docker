# -*- mode: ruby -*-
# vi: set ft=ruby :

# CONFIGURATION
# --------------------
# Total nodes to spawn
NUM_NODES = ENV['NUM_NODES'] ? ENV['NUM_NODES'].to_i : 3
# Base IP address (Nodes will be .11, .12, .13, etc.)
IP_SUBNET = "192.168.100."
IP_START = 11

Vagrant.configure("2") do |config|
  # BOX SELECTION
  # --------------------
  # If you are on Apple Silicon (M1/M2/M3), use the ARM64 box:
  config.vm.box = "bento/ubuntu-24.04"
  config.vm.box_version = "202510.26.0"
  
  # If you are on Intel Mac, uncomment this instead:
  # config.vm.box = "bento/ubuntu-24.04"

  # DISABLE DEFAULT SYNCED FOLDERS
  # --------------------
  # This prevents permission issues and speeds up boot time.
  # We use a specific folder for data sharing if needed.
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # NODE DEFINITION LOOP
  # --------------------
  (1..NUM_NODES).each do |i|
    config.vm.define "node#{i}" do |node|
      
      # Networking
      # We use a private network so they can talk to each other.
      # node1 -> 192.168.100.11
      # node.vm.network "public_network", 
      #   ip: "#{IP_SUBNET}#{IP_START + i - 1}", 
      #   use_dhcp_assigned_default_route: true,
      #   interface_options: {
      #     metric: 1
      #   }
      node.vm.network "private_network", ip: "#{IP_SUBNET}#{IP_START + i - 1}"
      
      # Hostname
      node.vm.hostname = "node#{i}.dev.local"

      # PROVIDER SPECIFIC: VMWARE FUSION
      # --------------------
      node.vm.provider "vmware_desktop" do |v|
        v.gui = false
        v.allowlist_verified = true
        
        # Resource Allocation
        # 5 VMs is a lot. We start conservative.
        # 2GB RAM / 2 vCPUs is a sweet spot for Etcd/K8s testing.
        v.memory = 2048
        v.cpus = 2
        
        # Optimize disk IO for database workloads (Etcd)
        v.vmx["scsi0.virtualDev"] = "pvscsi"
      end

      # PROVISIONING (Optional)
      # --------------------
      # Prepare the node (install Python for Ansible, etc.)
      # node.vm.provision "shell", inline: <<-SHELL
      #   apt-get update
      #   apt-get install -y python3 python3-pip avahi-daemon net-tools
      #   # Disable swap for Kubernetes (Best practice)
      #   swapoff -a
      #   sed -i '/swap/d' /etc/fstab
      # SHELL
      # node.vm.provision "shell", inline: <<-SHELL
      #   # Find the default gateway on eth0 and delete it
      #   ip route del default dev eth0
      # SHELL
    end
  end
end
